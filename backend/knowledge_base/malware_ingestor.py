import os
import glob
import markdown
from typing import List
from bs4 import BeautifulSoup
from .ingestor import KnowledgeIngestor

class MalwareTacticsIngestor(KnowledgeIngestor):
    """Ingests Malware Tactics from Markdown files (MITRE/Malpedia clones)."""
    
    COLLECTION_NAME = "malware_tactics"

    def ingest(self, source_path: str):
        collection = self.client.get_or_create_collection(name=self.COLLECTION_NAME)
        files = glob.glob(os.path.join(source_path, "**/*.md"), recursive=True)
        
        ids, docs, metas = [], [], []
        
        for i, fpath in enumerate(files):
            with open(fpath, 'r', encoding='utf-8') as f:
                md_text = f.read()
                
            # Convert MD to Text for cleaner embedding
            html = markdown.markdown(md_text)
            text = "".join(BeautifulSoup(html, "html.parser").findAll(text=True))
            
            # Simple chunking for now - ideally use recursive splitting
            chunks = self.chunk_content(text)
            
            base_name = os.path.basename(fpath)
            for j, chunk in enumerate(chunks):
                ids.append(f"malware_{i}_{j}")
                docs.append(chunk)
                metas.append({
                    "source": "malware_behavior", 
                    "filename": base_name,
                    "tactic": "unknown" # Parse YAML frontmatter if available later
                })
        
        if docs:
            collection.add(ids=ids, documents=docs, metadatas=metas)
            print(f"Ingested {len(docs)} malware tactic chunks.")

    def chunk_content(self, content: str) -> List[str]:
        # Basic paragraph splitter for Markdown
        return [p for p in content.split('\n\n') if len(p) > 50]
